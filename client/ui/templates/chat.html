<!DOCTYPE html>
<html lang="en">

<head>
    <title>Chat Application</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <script>
        const currentUsername = "{{ username }}";
    </script>
</head>

<body>
    <div class="chat-container">
        <!-- Sidebar Area -->
        <div class="room-sidebar">
            <div class="sidebar-header">
                <h2>Chat Rooms</h2>
                <button id="create-room" onclick="window.location.href='create_room'">+</button>
            </div>

            <div class="sidebar-content">
                <div class="join-room-section">
                    <form action="/join_room_by_code" method="POST" id="join-code-form">
                        <input type="text" name="room_code" placeholder="Enter Room Code" required>
                        <button type="submit" style="width: 100%; margin-top: 5px;">Join Room</button>
                    </form>
                </div>

                <h3>My Joined Rooms</h3>
                <ul>
                    {% for room in rooms %}
                    <li
                        class="{% if room._id|string == current_room_id %}active-room{% else %}inactive-room{% endif %}">
                        <a href="/join_room/{{ room._id }}">
                            {{ room.room_name }} <span class="room-code-badge">#{{ room.room_code }}</span>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-chat" data-room-id="{{ current_room_id }}">
            <header>
                <div class="header-main">
                    <div class="room-info">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <h2 id="room-name-display">{{ current_room.room_name if current_room else 'Select a Room' }}
                            </h2>
                            {% if current_room and username in current_room.admins %}
                            <button class="edit-room-name-btn" onclick="toggleRoomRename()"
                                title="Rename Room">âœ</button>
                            <div id="room-rename-input-container"
                                style="display: none; align-items: center; gap: 0.5rem;">
                                <input type="text" id="new-room-name" class="room-name-input"
                                    value="{{ current_room.room_name }}">
                                <button class="action-sm prom-btn"
                                    onclick="saveRoomName('{{ current_room_id }}')">Save</button>
                                <button class="action-sm kick-btn" onclick="toggleRoomRename()">Cancel</button>
                            </div>
                            {% endif %}
                        </div>
                        {% if current_room %}
                        <span class="room-code-display">Code: {{ current_room.room_code }}</span>
                        {% endif %}
                    </div>
                    <div class="header-right">
                        {% if current_room %}
                        {% if current_room.creator == username %}
                        <button onclick="deleteRoom('{{ current_room_id }}')" class="delete-btn action-btn">Delete
                            Room</button>
                        {% else %}
                        <button onclick="leaveRoom('{{ current_room_id }}')" class="leave-btn action-btn">Leave
                            Room</button>
                        {% endif %}
                        {% endif %}
                        <img src="{{ dp }}" alt="DP" class="header-dp" onclick="window.location.href='profile'">
                        <div class="brand">
                            <span>{{ username }}</span>
                        </div>
                        {% if current_room %}
                        <div class="call-actions">
                            <button onclick="startCall('voice')" class="action-btn call-btn"
                                title="Voice Call">ğŸ“</button>
                            <button onclick="startCall('video')" class="action-btn call-btn"
                                title="Video Call">ğŸ“¹</button>
                        </div>
                        {% endif %}
                        <button id="theme-toggle">ğŸŒ™</button>
                        <button onclick="window.location.href='/logout'" class="logout-btn">Logout</button>
                    </div>
                </div>
            </header>

            <div class="chat-content-flex">
                <div class="chat-box" id="chat-box">
                    {% if not current_room_id %}
                    <div class="system-message">Select a room to start chatting</div>
                    {% endif %}
                    {% for message in messages %}
                    <div class="message-wrapper {% if message.message_type == 'system' %}system-wrapper{% endif %}">
                        {% if message.message_type == 'system' %}
                        <div class="system-message">{{ message.message }}</div>
                        {% else %}
                        <div class="message-header">
                            <img src="/static/uploads/{{ message.profile_photo }}" alt="DP" class="msg-dp">
                            <strong>{{ message.sender }}</strong>
                        </div>
                        <div class="message-bubble {% if message.message_type == 'sticker' %}sticker-bubble{% endif %}">
                            {% if message.message_type == 'file' %}
                            <div class="file-message">
                                ğŸ“ <a href="{{ message.file_info.url }}" target="_blank" class="file-link">{{
                                    message.file_info.filename }}</a>
                            </div>
                            {% elif message.message_type == 'sticker' %}
                            <img src="{{ message.message }}" class="sticker-message">
                            {% elif message.message_type == 'call' %}
                            <div class="call-message">
                                {% if 'video' in message.message %}ğŸ“¹{% else %}ğŸ“{% endif %} {{ message.message }}
                            </div>
                            {% else %}
                            <p>{{ message.message }}</p>
                            {% endif %}
                            <span class="timestamp">{{ message.timestamp|to_ist if message.timestamp else '' }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <!-- Member List Sidebar -->
                {% if current_room %}
                <div class="member-sidebar">
                    <h3>Members ({{ members|length }})</h3>
                    <ul class="member-list">
                        {% for member in members %}
                        <li class="member-item">
                            <img src="/static/uploads/{{ member.profile_photo }}" alt="DP" class="member-dp">
                            <div class="member-info">
                                <span class="member-name">{{ member.full_name }}</span>
                                {% if member.username in current_room.admins %}
                                <span class="admin-badge">Admin</span>
                                {% endif %}

                                {% if member.username != username %}
                                <div class="member-call-actions">
                                    <button class="call-icon-btn" onclick="startCall('voice', '{{ member.username }}')"
                                        title="Voice Call">ğŸ“</button>
                                    <button class="call-icon-btn" onclick="startCall('video', '{{ member.username }}')"
                                        title="Video Call">ğŸ“¹</button>
                                </div>
                                {% endif %}

                                {% if username in current_room.admins %}
                                <div class="member-actions">

                                    {% if member.username not in current_room.admins %}
                                    <button class="action-btn action-sm prom-btn"
                                        onclick="promoteMember('{{ current_room_id }}', '{{ member.username }}')">Make
                                        Admin</button>
                                    {% endif %}

                                    {% if member.username != username and member.username != current_room.creator %}
                                    <button class="action-btn action-sm kick-btn"
                                        onclick="kickMember('{{ current_room_id }}', '{{ member.username }}')">Kick</button>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>

            <div class="input-area">
                <div class="input-actions-left">
                    <button id="emoji-btn" title="Add Emoji">ğŸ˜Š</button>
                    <button id="attach-btn" title="Attach File">ğŸ“</button>
                    <input type="file" id="file-input" style="display: none;" accept=".pdf,.doc,.docx,.txt,.jpg,.png">
                </div>
                <div class="emoji-picker-container" id="emoji-picker" style="display: none;">
                    <div class="emoji-picker-header">
                        <button class="picker-tab active" onclick="switchPickerTab('emojis')">Emoji</button>
                        <button class="picker-tab" onclick="switchPickerTab('stickers')">Stickers</button>
                    </div>
                    <div id="emoji-list" class="picker-grid">
                        <span>ğŸ˜€</span><span>ğŸ˜‚</span><span>ğŸ˜</span><span>ğŸ¤”</span><span>ğŸ˜</span><span>ğŸ‘</span><span>â¤ï¸</span><span>ğŸ™Œ</span><span>ğŸ‰</span><span>ğŸ”¥</span><span>âœ¨</span><span>ğŸ˜œ</span><span>ğŸ˜‡</span><span>ğŸ˜¢</span><span>ğŸ˜¡</span><span>ğŸ˜±</span>
                    </div>
                    <div id="sticker-list" class="picker-grid" style="display: none;">
                        <!-- Stickers will be loaded via JS -->
                    </div>
                </div>
                <input id="message" type="text" placeholder="Type a message..." autocomplete="off">
                <button id="send-btn">Send</button>
            </div>
        </div>
    </div>

    <!-- Call Overlay -->
    <div id="call-overlay" class="modal-overlay">
        <div class="call-container">
            <div id="call-status" class="call-status-overlay">
                <span id="call-status-text">Calling...</span>
            </div>
            <div id="video-grid"></div>
            <div class="call-controls">
                <button id="toggle-mic" class="control-btn">ğŸ™ï¸</button>
                <button id="toggle-video" class="control-btn">ğŸ“¹</button>
                <button id="end-call-btn" class="control-btn end-call">ğŸ“</button>
            </div>
        </div>
    </div>

    <!-- Incoming Call Modal -->
    <div id="incoming-call-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="caller-name">Incoming Call...</h3>
            <p id="call-type-text">Someone is calling you</p>
            <div class="modal-actions">
                <button class="confirm-btn action-btn bg-success" id="accept-call-btn">Accept</button>
                <button class="confirm-btn action-btn bg-danger" id="reject-call-btn">Reject</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="confirm-modal-title">Confirm Action</h3>
            <p id="confirm-modal-message">Are you sure you want to proceed?</p>
            <div class="modal-actions">
                <button class="cancel-btn action-btn" onclick="closeConfirmModal()">Cancel</button>
                <button id="confirm-modal-btn" class="confirm-btn action-btn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="/static/script.js"></script>
</body>

</html>